<html lang="en">
<head>
    <meta charset="utf-8" />
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="page-shell">
    <div class="toolbar">
        <div class="actions">
            <a id="delete_bnt" class="btn btn-ghost" style="display: none;" onclick="deleteNews();">删除</a>
            <a id="edit_bnt" class="btn btn-primary" style="display: none;" onclick="edit();">编辑</a>
            <a href="/news" class="btn btn-ghost">返回列表</a>
        </div>
        <div>
            <a href="/login" id="login" class="btn btn-ghost">登录</a>
            <a href="/modify_pass" id="user_name" class="pill" style="display: none;"></a>
            <a id="log_out" class="btn btn-ghost" style="display: none;" onclick="logout();">退出</a>
        </div>
    </div>

    <div id="view" class="card" style="display: block;">
        <div id="title" class="hero-title">{{.Title}}</div>
        <div class="news-meta">
            <span>作者：{{.UserName}}</span>
            <span>发布时间：{{.ViewPostTime}}</span>
        </div>
        <div id="article" class="content-box">{{.Content}}</div>
    </div>
    <div id="update" class="card" style="display: none;">
        <div class="hero-title">编辑新闻</div>
        <div class="form">
            <div>
                <label for="edit_title">标题</label>
                <input type="text" id="edit_title" value="{{.Title}}">
            </div>
            <div>
                <label for="edit_article">内容</label>
                <textarea id="edit_article" rows="12">{{.Content}}</textarea>
            </div>
            <button id="update_bnt" class="btn btn-primary" onclick="update();">提交修改</button>
            <div id="msg" class="message"></div>
        </div>
    </div>
</div>

<script>
    // 1. 编辑切换
    function edit() {
        $("#view").hide();
        $("#update").show();
        $("#msg").html("");
    }

    // 2. 删除新闻
    function deleteNews() {
        // 从URL提取新闻ID（如 /news/4 → id=4）
        const newsId = window.location.pathname.split("/").pop();
        if (!confirm("确定删除这篇新闻吗？")) return;

        $.ajax({
            type: "DELETE",
            url: "/news/delete/" + newsId,
            xhrFields: { withCredentials: true },
            success: function () {
                window.location.replace("/news");
            },
            error: function (xhr) {
                alert(xhr.responseText || "删除失败");
            }
        });
    }

    // 3. 修改新闻
    function update() {
        const title = $("#edit_title").val().trim();
        const content = $("#edit_article").val().trim();
        const newsId = window.location.pathname.split("/").pop();

        // 表单校验
        if (!title) {
            $("#msg").html("标题不能为空");
            return;
        }
        if (!content) {
            $("#msg").html("内容不能为空");
            return;
        }

        $.ajax({
            type: "POST",
            url: "/news/update",
            data: { "title": title, "content": content, "id": newsId },
            xhrFields: { withCredentials: true }, // 携带登录态
            success: function () {
                window.location.replace("/news/" + newsId);
            },
            error: function (xhr) {
                $("#msg").html(xhr.responseText || "修改失败");
            }
        });
    }

    // 4. 退出登录
    function logout() {
        $.ajax({
            url: "/logout/submit",
            method: "GET",
            xhrFields: { withCredentials: true },
            success: function () {
                show_login();
                window.location.reload();
            }
        });
    }

    // 5. 登录/退出状态切换
    function show_login() {
        $("#login").show();
        $("#user_name").hide();
        $("#log_out").hide();
    }
    function show_out(name) {
        $("#login").hide();
        $("#user_name").show().html(name);
        $("#log_out").show();
    }

    // 6. 页面加载时：校验权限（显示删除/修改按钮）+ 显示登录状态
    $(document).ready(function () {
        // 提取当前新闻ID
        const newsId = window.location.pathname.split("/").pop();

        // 6.1 权限校验：调用 /news/belong 接口
        $.ajax({
            type: "GET",
            url: "/news/belong",
            data: { "id": newsId }, // 传递新闻ID
            xhrFields: { withCredentials: true }, // 必须携带登录态
            success: function (result) {
                // 后端返回 "true" 则显示按钮
                if (result === "true") {
                    $("#edit_bnt").show();
                    $("#delete_bnt").show();
                }
            },
            error: function (xhr) {
                console.log("权限校验失败：", xhr.responseText);
            }
        });

        // 6.2 显示登录状态
        $.ajax({
            url: "/user",
            method: "GET",
            xhrFields: { withCredentials: true },
            success: function (result) {
                if (result.Name) {
                    show_out(result.Name);
                } else {
                    show_login();
                }
            }
        });
    });
</script>
</body>
</html>