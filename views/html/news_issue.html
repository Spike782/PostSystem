<html lang="en">

<head>
    <meta charset="utf-8" />
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="/js/my.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <title>发布新闻</title>
</head>

<body>
    <span style="position: absolute;right: 2%;">
        <a href="/login" id="login">登录</a>
        <a href="/modify_pass" onclick="" id="user_name"></a>
        <a id="log_out" style="display: none;" onclick="logout();">退出</a>
    </span>

    <div align="center" style="width: 50%; margin: auto;">
        <input type="text" id="issue_title" style="width: 100%;" name="issue_title" value=""></input><br>
        <hr><br>
        <textarea id="issue_article" name="issue_article" rows="15" style="width: 100%;"></textarea><br><br>
        <button id="issue_bnt" onclick="issue();">提交</button><br>
        <span id="msg" style="color: red;"></span>
    </div>
    <script>
        function issue() {
            var title = document.querySelector("#issue_title").value.trim();
            var article = document.querySelector("#issue_article").value.trim();
            // 表单校验
            if (!title) {
                $('#msg').html("标题不能为空！");
                return;
            }
            if (!article) {
                $('#msg').html("内容不能为空！");
                return;
            }
            $.ajax({
                type: "POST",
                url: "/news/issue/submit",
                data: { "title": title, "content": article },
                xhrFields: { withCredentials: true },
                timeout: 5000,
                success: function (result) {
                    window.location.replace("/news/" + result.id);
                },
                error: function (xhr, status, error) {
                    if (status === "timeout") {
                        $('#msg').html("网络超时，请检查网络后重试！");
                    } else {
                        $('#msg').html(xhr.responseText || "发布失败：" + error);
                    }
                }
            });
        };

        function logout() {
            $.ajax({
                url: "/logout",
                method: "get",
                xhrFields: { withCredentials: true },
                timeout: 3000,
                success: function (result) {
                    show_login();
                    // 清空表单和提示
                    $("#issue_title").val("");
                    $("#issue_article").val("");
                    $("#msg").html("");
                },
                error: function () {
                    $('#msg').html("退出失败，请重试！");
                }
            })
        };

        // 补充登录/退出状态切换函数
        function show_login() {
            $("#login").show();
            $("#user_name").hide();
            $("#log_out").hide();
            $("#user_name").html("");
        }

        function show_out(name) {
            $("#login").hide();
            $("#user_name").show();
            $("#log_out").show();
            $("#user_name").html(name);
        }

        // 页面加载时查询登录状态
        $(document).ready(function () {
            $.ajax({
                url: "/user",
                method: "get",
                xhrFields: { withCredentials: true }, // 确保携带Cookie，后端才能识别登录态
                timeout: 3000,
                success: function (result) {
                    if (result.Name) {
                        show_out(result.Name);
                    } else {
                        show_login(); // 未登录时主动切换状态（避免按钮显示异常）
                    }
                },
                error: function () {
                    show_login(); // 网络异常时默认显示登录按钮
                }
            })
        });
    </script>
</body>