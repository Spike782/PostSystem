<html lang="en">

<head>
    <meta charset="utf-8" />
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <title>发布新闻</title>
    <link rel="stylesheet" href="/css/main.css">
</head>

<body>
    <div class="page-shell">
        <div class="toolbar">
            <a href="/login" id="login" class="btn btn-ghost">登录</a>
            <a href="/modify_pass" id="user_name" class="pill" style="display: none;"></a>
            <a id="log_out" class="btn btn-ghost" style="display: none;" onclick="logout();">退出</a>
        </div>

        <div class="card">
            <div class="hero-title">发布一条新资讯</div>
            <div class="hero-subtitle">分享你对热点的见解，让更多人看到</div>
            <div class="form">
                <div>
                    <label for="issue_title">标题</label>
                    <input type="text" id="issue_title" name="issue_title" placeholder="一句话概括这条新闻">
                </div>
                <div>
                    <label for="issue_article">内容</label>
                    <textarea id="issue_article" name="issue_article" rows="12" placeholder="输入完整正文..."></textarea>
                </div>
                <button id="issue_bnt" class="btn btn-primary" onclick="issue();">提交发布</button>
                <div class="message" id="msg"></div>
            </div>
        </div>
    </div>
    <script>
        function issue() {
            const title = $("#issue_title").val().trim();
            const article = $("#issue_article").val().trim();
            // 表单校验
            if (!title) {
                $('#msg').html("标题不能为空！");
                return;
            }
            if (!article) {
                $('#msg').html("内容不能为空！");
                return;
            }
            $.ajax({
                type: "POST",
                url: "/news/issue/submit",
                data: { "title": title, "content": article },
                xhrFields: { withCredentials: true },
                timeout: 5000,
                success: function (result) {
                    window.location.replace("/news/" + result.id);
                },
                error: function (xhr, status, error) {
                    if (status === "timeout") {
                        $('#msg').html("网络超时，请检查网络后重试！");
                    } else {
                        $('#msg').html(xhr.responseText || "发布失败：" + error);
                    }
                }
            });
        };

        function logout() {
            $.ajax({
                url: "/logout/submit",
                method: "GET",
                xhrFields: { withCredentials: true },
                timeout: 3000,
                success: function (result) {
                    show_login();
                    // 清空表单和提示
                    $("#issue_title").val("");
                    $("#issue_article").val("");
                    $("#msg").html("");
                },
                error: function () {
                    $('#msg').html("退出失败，请重试！");
                }
            })
        };

        // 补充登录/退出状态切换函数
        function show_login() {
            $("#login").show();
            $("#user_name").hide();
            $("#log_out").hide();
            $("#user_name").html("");
        }

        function show_out(name) {
            $("#login").hide();
            $("#user_name").show();
            $("#log_out").show();
            $("#user_name").html(name);
        }

        // 页面加载时查询登录状态
        $(document).ready(function () {
            $.ajax({
                url: "/user",
                method: "get",
                xhrFields: { withCredentials: true }, // 确保携带Cookie，后端才能识别登录态
                timeout: 3000,
                success: function (result) {
                    if (result.Name) {
                        show_out(result.Name);
                    } else {
                        show_login(); // 未登录时主动切换状态（避免按钮显示异常）
                    }
                },
                error: function () {
                    show_login(); // 网络异常时默认显示登录按钮
                }
            })
        });
    </script>
</body>